trigger:
- master

pool:
  vmImage: 'macOS-10.13'

variables:
  PATH: "$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
  CC_OPT_FLAGS: '-mavx'
  TF_NEED_HDFS: 0
  TF_NEED_CUDA: 0
  TF_NEED_ROCM: 0
  TF_NEED_OPENCL_SYCL: 0
  TF_NEED_MKL: 0
  COMPUTECPP_PATH: "/usr/local"

steps:
- script: brew install bazel
  displayName: Install Bazel Build

- script: |
    git clone https://github.com/tensorflow/tensorflow --depth=20 
    cd tensorflow
    yes "" | 
    #!/usr/bin/env bash
    set -e
    set -o pipefail
    if [ -z "$PYTHON_BIN_PATH" ]; then
      PYTHON_BIN_PATH=$(which python || which python3 || true)
    fi
    # Set all env variables
    CONFIGURE_DIR=$(dirname "$0")
    "$PYTHON_BIN_PATH" "${CONFIGURE_DIR}/configure.py" "$@"
    echo "Configuration finished"
  
  displayName: Prepare Tensorflow

- script: bazel build -c opt --copt=-mavx --copt=-mavx2 --copt=-mfma  --copt=-msse4.2 --config=monolithic //tensorflow:libtensorflow_cc.so
  displayName: Bazel Build
