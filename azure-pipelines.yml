trigger:
- master
pool:
  vmImage: 'macOS-10.13'
variables:
  PATH: "$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
  CC_OPT_FLAGS: '-mavx'
  TF_NEED_HDFS: 0
  TF_NEED_CUDA: 0
  TF_NEED_ROCM: 0
  TF_NEED_OPENCL_SYCL: 0
  TF_NEED_MKL: 0
  COMPUTECPP_PATH: "/usr/local"

steps:
- script: brew install bazel
  displayName: Install Bazel Build
- script: |
    git clone https://github.com/tensorflow/tensorflow --depth=20 
  displayName: Clone TensorFlow
- script: |
    cd tensorflow
    python ./configure.py <<-EOF
    yes ""
    EOF
  displayName: Configure TensorFlow Build
- script: |
    cd tensorflow
    bazel build -c opt --copt=-mavx --copt=-mavx2 --copt=-mfma  --copt=-msse4.2 --config=monolithic //tensorflow:libtensorflow_cc.so
  displayName: Bazel Build
- task: PublishPipelineArtifact@0
  inputs:
    artifactName: 'libtensorflow-cc'
    targetPath: 'tensorflow/build_artifacts'
